diff -ru krb5-1.4.4/src/lib/kadm5/admin.h krb5-1.4.4-patched/src/lib/kadm5/admin.h
--- krb5-1.4.4/src/lib/kadm5/admin.h	2005-11-28 16:01:49.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/admin.h	2007-07-29 19:12:55.000000000 -0700
@@ -227,6 +227,7 @@
      char *		admin_keytab;
      char *		acl_file;
      char *		dict_file;
+     char *		pwupdate_plugin;
 
      int		mkey_from_kbd;
      char *		stash_file;
diff -ru krb5-1.4.4/src/lib/kadm5/alt_prof.c krb5-1.4.4-patched/src/lib/kadm5/alt_prof.c
--- krb5-1.4.4/src/lib/kadm5/alt_prof.c	2004-06-24 13:08:30.000000000 -0700
+++ krb5-1.4.4-patched/src/lib/kadm5/alt_prof.c	2007-07-29 19:12:55.000000000 -0700
@@ -515,6 +515,16 @@
 	 params.dict_file = svalue;
     }
 	    
+    /* Get the value for the pwsync plugin */
+    hierarchy[2] = "pwupdate_plugin";
+    if (aprofile &&
+	!krb5_aprof_get_string(aprofile, hierarchy, TRUE,
+			       &svalue)) {
+	 params.pwupdate_plugin = svalue;
+    } else {
+	 params.pwupdate_plugin = NULL;
+    }
+    
     /* Get the value for the kadmind port */
     if (! (params.mask & KADM5_CONFIG_KADMIND_PORT)) {
 	 hierarchy[2] = "kadmind_port";
Only in krb5-1.4.4-patched/src/lib/kadm5: alt_prof.c.orig
diff -ru krb5-1.4.4/src/lib/kadm5/configure.in krb5-1.4.4-patched/src/lib/kadm5/configure.in
--- krb5-1.4.4/src/lib/kadm5/configure.in	2004-02-12 19:19:30.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/configure.in	2007-07-29 19:12:55.000000000 -0700
@@ -10,10 +10,12 @@
 AC_CHECK_PROG(RUNTEST,runtest,runtest)
 AC_CHECK_PROG(PERL,perl,perl)
 AC_CHECK_FUNCS(srand48 srand srandom)
+AC_CHECK_LIB(dl, dlopen, DL_LIB=-ldl)
 AC_KRB5_TCL	
 if test "$PERL" = perl -a "$RUNTEST" = runtest -a "$TCL_LIBS" != ""; then
  	DO_TEST=ok
 fi
+AC_SUBST(DL_LIB)
 AC_SUBST(DO_TEST) 
 dnl
 KRB5_BUILD_LIBOBJS
diff -ru krb5-1.4.4/src/lib/kadm5/server_internal.h krb5-1.4.4-patched/src/lib/kadm5/server_internal.h
--- krb5-1.4.4/src/lib/kadm5/server_internal.h	2005-11-28 16:01:49.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/server_internal.h	2007-07-29 19:12:55.000000000 -0700
@@ -62,6 +62,9 @@
 int		    find_word(const char *word);
 void		    destroy_dict(void);
 
+int		    init_pwupdate(krb5_context, kadm5_config_params *);
+void		    destroy_pwupdate(void);
+
 /* XXX this ought to be in libkrb5.a, but isn't */
 kadm5_ret_t krb5_copy_key_data_contents(krb5_context context,
 					krb5_key_data *from, 
diff -ru krb5-1.4.4/src/lib/kadm5/srv/Makefile.in krb5-1.4.4-patched/src/lib/kadm5/srv/Makefile.in
--- krb5-1.4.4/src/lib/kadm5/srv/Makefile.in	2005-11-28 16:23:12.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/srv/Makefile.in	2007-07-29 19:12:55.000000000 -0700
@@ -21,7 +21,7 @@
 	$(TOPLIBD)/libk5crypto$(SHLIBEXT) \
 	$(COM_ERR_DEPLIB)
 SHLIB_EXPLIBS =	-lgssrpc -lgssapi_krb5 -lkdb5 $(KDB5_DB_LIB) \
-		-lkrb5 -lk5crypto -lcom_err @GEN_LIB@
+		-lkrb5 -lk5crypto -lcom_err @GEN_LIB@ @DL_LIB@
 SHLIB_DIRS=-L$(TOPLIBD)
 SHLIB_RDIRS=$(KRB5_LIBDIR)
 RELDIR=kadm5/srv
diff -ru krb5-1.4.4/src/lib/kadm5/srv/server_init.c krb5-1.4.4-patched/src/lib/kadm5/srv/server_init.c
--- krb5-1.4.4/src/lib/kadm5/srv/server_init.c	2005-11-28 16:01:49.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/srv/server_init.c	2007-07-29 19:12:55.000000000 -0700
@@ -272,6 +272,15 @@
 	 return ret;
     }
     
+    ret = init_pwupdate(handle->context, &handle->params);
+    if (ret) {
+         krb5_db_fini(handle->context);
+	 krb5_free_principal(handle->context, handle->current_caller);
+	 krb5_free_context(handle->context);
+	 free(handle);
+	 return ret;
+    }
+
     ret = adb_policy_init(handle);
     if (ret) {
 	 krb5_db_fini(handle->context);
@@ -294,6 +303,7 @@
     CHECK_HANDLE(server_handle);
 
     destroy_dict();
+    destroy_pwupdate();
 
     adb_policy_close(handle);
     krb5_db_fini(handle->context);
diff -ru krb5-1.4.4/src/lib/kadm5/srv/svr_principal.c krb5-1.4.4-patched/src/lib/kadm5/srv/svr_principal.c
--- krb5-1.4.4/src/lib/kadm5/srv/svr_principal.c	2005-11-28 16:01:49.000000000 -0800
+++ krb5-1.4.4-patched/src/lib/kadm5/srv/svr_principal.c	2007-07-29 19:12:55.000000000 -0700
@@ -23,6 +23,9 @@
 #include	<sys/wait.h>
 #endif
 
+#include	<dlfcn.h>
+#include	<syslog.h>
+
 extern	krb5_principal	    master_princ;
 extern	krb5_principal	    hist_princ;
 extern	krb5_keyblock	    master_keyblock;
@@ -35,6 +38,17 @@
 			    int n_key_data, krb5_key_data *key_data,
 			    krb5_keyblock **keyblocks, int *n_keys);
 
+static void *update_handle = NULL;
+static int (*d_pwupdate_init)(krb5_context, void **) = NULL;
+static int (*d_pwupdate_precommit_password)(void *, krb5_principal, char *,
+                                            int, char *, int) = NULL;
+static int (*d_pwupdate_postcommit_password)(void *, krb5_principal, char *,
+                                             int, char *, int) = NULL;
+static int (*d_pwupdate_postcommit_status)(void *, krb5_principal, int,
+                                           char *, int) = NULL;
+static int (*d_pwupdate_close)(void *) = NULL;
+static void *pwupdate_context = NULL;
+
 /*
  * XXX Functions that ought to be in libkrb5.a, but aren't.
  */
@@ -238,6 +252,25 @@
 	return(ret);
     }
 
+    /*
+     * If we have a precommit password update entry point, call that now
+     * before any database modifications.
+     */
+
+    if (d_pwupdate_precommit_password) {
+    	char errstr[256];
+
+	ret = (*d_pwupdate_precommit_password)(pwupdate_context,
+                                               entry->principal, password,
+					       strlen(password), errstr,
+					       sizeof(errstr));
+	if (ret) {
+	    krb5_klog_syslog(LOG_ERR, "External password update failed: "
+			     "%s (%d)", errstr, ret);
+	    return ret;
+	}
+    }
+
     if ((ret = krb5_dbe_update_last_pwd_change(handle->context, &kdb, now))) {
          krb5_dbe_free_contents(handle->context, &kdb);
 	 if (mask & KADM5_POLICY)
@@ -328,6 +361,18 @@
 	return(ret);
     }
 
+    if (d_pwupdate_postcommit_password) {
+	char errstr[256];
+
+	ret = (*d_pwupdate_postcommit_password)(pwupdate_context,
+						entry->principal, password,
+						strlen(password), errstr,
+						sizeof(errstr));
+	if (ret)
+	    krb5_klog_syslog(LOG_ERR, "WARNING: External password update "
+			     "failed: %s (%d)", errstr, ret);
+    }
+
     if (mask & KADM5_POLICY)
 	 (void) kadm5_free_policy_ent(handle->lhandle, &polent);
 
@@ -515,8 +560,22 @@
 					     KADM5_REF_COUNT)))))
 	goto done;
 
-    if ((mask & KADM5_ATTRIBUTES)) 
+    if ((mask & KADM5_ATTRIBUTES)) {
+	if (d_pwupdate_postcommit_status
+	    && ((kdb.attributes & KRB5_KDB_DISALLOW_ALL_TIX) !=
+		(entry->attributes & KRB5_KDB_DISALLOW_ALL_TIX))) {
+	    char errstr[256];
+	    int enabled = (entry->attributes & KRB5_KDB_DISALLOW_ALL_TIX) == 0;
+
+	    ret = (*d_pwupdate_postcommit_status)(pwupdate_context,
+						  entry->principal, enabled,
+						  errstr, sizeof(errstr));
+	    if (ret)
+		krb5_klog_syslog(LOG_ERR, "External status update failed: "
+				 "%s (%d)", errstr, ret);
+	}
 	kdb.attributes = entry->attributes;
+    }
     if ((mask & KADM5_MAX_LIFE))
 	kdb.max_life = entry->max_life;
     if ((mask & KADM5_PRINC_EXPIRE_TIME))
@@ -1250,6 +1309,24 @@
 			    KADM5_POLICY, &pol, principal)))
 	 goto done;
 
+    /*
+     * If we have a precommit password update entry point, call that now
+     * before any database modifications.
+     */
+
+    if (d_pwupdate_precommit_password) {
+	char errstr[256];
+
+	ret = (*d_pwupdate_precommit_password)(pwupdate_context, principal,
+					       password, strlen(password),
+					       errstr, sizeof(errstr));
+	if (ret) {
+	    krb5_klog_syslog(LOG_ERR, "External password update failed: "
+			     "%s (%d)", errstr, ret);
+	    return ret;
+	}
+    }
+
     ret = krb5_dbe_cpw(handle->context, &master_keyblock,
 		       n_ks_tuple?ks_tuple:handle->params.keysalts,
 		       n_ks_tuple?n_ks_tuple:handle->params.num_keysalts,
@@ -1367,6 +1444,17 @@
     if ((ret = kdb_put_entry(handle, &kdb, &adb)))
 	goto done;
 
+    if (d_pwupdate_postcommit_password) {
+	char errstr[256];
+
+	ret = (*d_pwupdate_postcommit_password)(pwupdate_context, principal,
+						password, strlen(password),
+						errstr, sizeof(errstr));
+	if (ret)
+	    krb5_klog_syslog(LOG_ERR, "WARNING: External password update "
+			     "failed: %s (%d)", errstr, ret);
+    }
+
     ret = KADM5_OK;
 done:
     if (!hist_added && hist.key_data)
@@ -1946,3 +2034,71 @@
 
     return KADM5_OK;
 }
+
+/*
+ * Function: init_pwupdate
+ *
+ * Initialize the password update module (if we have one)
+ *
+ * Right now all we do is look for a module named "pwupdate.so" in the
+ * same directory as the database.  Later on this should be cleaned up.
+ */
+
+int
+init_pwupdate(krb5_context context, kadm5_config_params *params)
+{
+    int ret;
+
+    if (params->pwupdate_plugin) {
+        update_handle = dlopen(params->pwupdate_plugin, RTLD_NOW);
+
+        if (! update_handle) {
+            krb5_klog_syslog(LOG_ERR, "ERROR: Unable to load plugin "
+                             "\"%s\": %s", params->pwupdate_plugin,
+                             dlerror());
+            return KADM5_FAILURE;
+        }
+
+        d_pwupdate_init = dlsym(update_handle, "pwupdate_init");
+        d_pwupdate_precommit_password = dlsym(update_handle,
+                                              "pwupdate_precommit_password");
+        d_pwupdate_postcommit_password = dlsym(update_handle,
+                                               "pwupdate_postcommit_password");
+	d_pwupdate_postcommit_status = dlsym(update_handle,
+					     "pwupdate_postcommit_status");
+        d_pwupdate_close = dlsym(update_handle, "pwupdate_close");
+
+        if (d_pwupdate_init == NULL
+            || d_pwupdate_close == NULL
+	    || (d_pwupdate_precommit_password == NULL &&
+		d_pwupdate_postcommit_password == NULL &&
+		d_pwupdate_postcommit_status == NULL)) {
+            krb5_klog_syslog(LOG_ERR, "ERROR: Needed symbols missing in "
+                             "pwupdate plugin");
+            dlclose(update_handle);
+            update_handle = NULL;
+            return KADM5_FAILURE;
+        }
+
+        ret = (*d_pwupdate_init)(context, &pwupdate_context);
+
+        if (ret != 0) {
+            krb5_klog_syslog(LOG_ERR, "ERROR: Password update plugin "
+                             "initialization failed with code %d", ret);
+            dlclose(update_handle);
+            update_handle = NULL;
+            return KADM5_FAILURE;
+        }
+
+        krb5_klog_syslog(LOG_INFO, "Password update plugin \"%s\" initialized",
+                         params->pwupdate_plugin);
+    }
+    return KADM5_OK;
+}
+
+void
+destroy_pwupdate(void)
+{
+    if (d_pwupdate_close)
+	(*d_pwupdate_close)(pwupdate_context);
+}
